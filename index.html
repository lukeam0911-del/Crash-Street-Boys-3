<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash Street - Stock Market Crash Gaming</title>
    <!-- Stripe Mock Script -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #666666;
            --accent-green: #00ff88;
            --accent-red: #ff3333;
            --border-color: #2a2a2a;
            --hover-bg: #1a1a1a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
            letter-spacing: -0.02em;
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 300;
            letter-spacing: -0.03em;
        }

        h1 {
            font-size: 3.5rem;
        }

        h2 {
            font-size: 2rem;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            height: 80px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 200;
            letter-spacing: -0.05em;
        }

        .logo span {
            color: var(--accent-green);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .redeem-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 300;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .redeem-btn:hover {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .user-stats {
            display: flex;
            align-items: center;
            gap: 25px;
            padding: 15px 25px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .referral-code,
        .balance,
        .username {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .label {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
        }

        .value {
            font-size: 1.1rem;
            font-weight: 300;
            margin-top: 2px;
        }

        .balance .value {
            color: var(--accent-green);
        }

        .login-btn,
        .logout-btn {
            padding: 12px 28px;
            background: var(--text-primary);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            font-weight: 400;
            letter-spacing: 0.02em;
            transition: all 0.3s ease;
        }

        .login-btn:hover,
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.1);
        }

        /* Main Container */
        .main-container {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
            height: calc(100vh - 160px);
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Main Page */
        .main-page-optimized {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 40px;
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 100;
            letter-spacing: -0.04em;
            margin-bottom: 10px;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            font-weight: 300;
        }

        .ticker-grid-optimized {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 30px;
            flex: 1;
            margin-bottom: 40px;
        }

        .ticker-card.enhanced {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
        }

        .ticker-card.enhanced:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--accent-green);
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.15);
        }

        /* Badges */
        .ticker-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .ticker-badge.safe {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .ticker-badge.moderate {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--text-primary);
        }

        .ticker-badge.balanced {
            background: rgba(255, 183, 0, 0.2);
            color: #ffb700;
            border: 1px solid #ffb700;
        }

        .ticker-badge.risky {
            background: rgba(255, 107, 0, 0.2);
            color: #ff6b00;
            border: 1px solid #ff6b00;
        }

        .ticker-badge.extreme {
            background: rgba(255, 51, 51, 0.2);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .ticker-volatility {
            width: 100%;
            height: 4px;
            background: var(--bg-tertiary);
            margin: 15px 0;
        }

        .volatility-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-red));
            transition: width 0.3s ease;
        }

        .ticker-description {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 10px;
            font-style: italic;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: auto;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 200;
            color: var(--accent-green);
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            z-index: 999;
        }

        .nav-btn {
            padding: 12px 30px;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 300;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            border-color: var(--text-primary);
            background: var(--hover-bg);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        /* Game Page */
        .game-container {
            display: flex;
            gap: 40px;
            height: calc(100vh - 240px);
        }

        .chart-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chart-container {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
        }

        .multiplier-display {
            position: absolute;
            top: 30px;
            left: 30px;
            font-size: 3rem;
            font-weight: 200;
            letter-spacing: -0.03em;
        }

        .multiplier-display.positive {
            color: var(--accent-green);
        }

        .multiplier-display.negative {
            color: var(--accent-red);
        }

        .market-halt-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 51, 51, 0.1);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .market-halt-overlay.active {
            display: flex;
        }

        .market-halt-text {
            font-size: 4rem;
            font-weight: 100;
            color: var(--accent-red);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .betting-controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .bet-input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .bet-input-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .bet-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 300;
            outline: none;
        }

        .bet-input:focus {
            border-color: var(--accent-green);
        }

        .quick-bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-bet {
            padding: 8px 16px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .quick-bet:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .place-bet-btn,
        .cash-out-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 400;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .place-bet-btn {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .cash-out-btn {
            background: var(--accent-red);
            color: var(--text-primary);
            display: none;
        }

        .cash-out-btn.active {
            display: block;
        }

        .place-bet-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .round-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            position: relative;
        }

        .round-stat {
            text-align: center;
        }

        .round-stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
        }

        .round-stat-value {
            font-size: 1.3rem;
            font-weight: 300;
        }

        .round-timer {
            color: var(--accent-green);
        }

        .exit-game-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: transparent;
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .exit-game-btn:hover {
            background: var(--accent-red);
            color: var(--text-primary);
        }

        .history-panel {
            width: 300px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-multiplier.won {
            color: var(--accent-green);
        }

        .history-multiplier.lost {
            color: var(--accent-red);
        }

        /* Inventory */
        .inventory-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .loadout-cards {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .card-slot {
            min-width: 120px;
            height: 180px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding: 10px;
        }

        .card-slot:hover {
            border-color: var(--accent-green);
            transform: translateY(-5px);
        }

        .card-slot.empty {
            border-style: dashed;
            opacity: 0.7;
        }

        .card-slot.locked {
            background: linear-gradient(135deg, rgba(255, 51, 51, 0.1), transparent);
            border-color: var(--accent-red);
            opacity: 0.8;
        }

        .unequip-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: var(--accent-red);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .card-slot:hover .unequip-btn {
            opacity: 1;
        }

        .collection-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-top: 40px;
        }

        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .collection-card {
            aspect-ratio: 3/4;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 10px;
        }

        .collection-card.owned {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), transparent);
        }

        .collection-card.equipped {
            border-color: var(--accent-green);
            border-width: 2px;
        }

        /* Rarity */
        .card-slot.common,
        .collection-card.common {
            border-color: #808080;
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.1), transparent);
        }

        .card-slot.uncommon,
        .collection-card.uncommon {
            border-color: #00ff88;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.15), transparent);
        }

        .card-slot.rare,
        .collection-card.rare {
            border-color: #00aaff;
            background: linear-gradient(135deg, rgba(0, 170, 255, 0.2), transparent);
        }

        .card-slot.legendary,
        .collection-card.legendary {
            border-color: #ffaa00;
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.25), transparent);
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.3);
        }

        .card-slot.mythic,
        .collection-card.mythic {
            border-color: #ff00ff;
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(255, 0, 0, 0.1));
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.4);
            animation: mythicGlow 2s infinite;
        }

        @keyframes mythicGlow {
            50% {
                box-shadow: 0 0 50px rgba(255, 0, 255, 0.6);
            }
        }

        /* Shop */
        .shop-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .shop-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            border-color: var(--accent-green);
        }

        .purchase-btn {
            width: 100%;
            padding: 15px;
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 400;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .purchase-btn:hover {
            background: var(--text-primary);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 200;
            margin-bottom: 20px;
        }

        .form-input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            cursor: pointer;
        }

        .modal-btn.primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Effects Summary & Pack Opening CSS preserved in spirit, shortened for brevity */
        .pack-opening-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .pack-opening-overlay.active {
            display: flex;
        }

        .revealed-card {
            width: 180px;
            height: 260px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            margin: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: cardFlip 0.6s ease;
        }
    </style>
</head>
<button class="cash-out-btn" id="cashOutBtn" onclick="cashOut()">CASH OUT</button>
</div>
</div>
<div class="history-panel">
    <div id="gameHistory"></div>
</div>
</div>
</div>

<!-- Inventory Page -->
<div class="page" id="inventoryPage">
    <div class="inventory-container">
        <div style="text-align:center; margin-bottom: 20px;">
            <button class="purchase-btn" style="max-width:200px;" onclick="openPack()">OPEN PACK</button>
        </div>
        <div class="loadout-section">
            <div class="loadout-cards" id="loadoutCards"></div>
        </div>
        <div class="collection-section">
            <div class="collection-grid" id="collectionGrid"></div>
        </div>
    </div>
</div>

<!-- Shop Page -->
<div class="page" id="shopPage">
    <div class="shop-container">
        <div class="shop-grid">
            <div class="shop-item">
                <div class="shop-item-title">Card Pack</div>
                <div class="shop-item-price">500 CC</div>
                <button class="purchase-btn" onclick="buyCardPack()">PURCHASE</button>
            </div>
            <!-- Provably Fair / Security Deposit placeholder could go here later -->
        </div>
    </div>
</div>

<!-- REMOVED FRIENDS PAGE -->
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
    <button class="nav-btn active" onclick="showPage('mainPage')">HOME</button>
    <button class="nav-btn" onclick="showPage('inventoryPage')">INVENTORY</button>
    <button class="nav-btn" onclick="showPage('shopPage')">SHOP</button>
    <!-- REMOVED FRIENDS BUTTON -->
    <button class="nav-btn" onclick="showEnterCodeModal()">ENTER CODE</button>
</div>

<!-- Modals -->
<div class="modal" id="loginModal">
    <div class="modal-content">
        <div class="modal-title">Welcome Back</div>
        <div class="form-group">
            <input type="text" class="form-input" id="usernameInput" placeholder="Enter Username">
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" onclick="closeModal('loginModal')">CANCEL</button>
            <button class="modal-btn primary" onclick="register()">PLAY</button>
        </div>
    </div>
</div>

<div class="modal" id="enterCodeModal">
    <div class="modal-content">
        <div class="modal-title">Enter Referral Code</div>
        <div class="form-group">
            <input type="text" class="form-input" id="referralInput" placeholder="Code (e.g. WELCOME)">
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" onclick="closeModal('enterCodeModal')">CANCEL</button>
            <button class="modal-btn primary" onclick="submitReferralCode()">REDEEM</button>
        </div>
    </div>
</div>

<div class="modal" id="redeemModal">
    <div class="modal-content">
        <div class="modal-title">Redeem Prizes</div>
        <p>Cash out your Crash Cash for real world rewards!</p>
        <div class="modal-footer">
            <button class="modal-btn primary" onclick="closeModal('redeemModal')">CLOSE</button>
        </div>
    </div>
</div>

<div class="modal" id="fairnessModal">
    <div class="modal-content">
        <div class="modal-title">Provably Fair</div>
        <div class="form-group">
            <label class="form-label">Server Seed (Hashed)</label>
            <input type="text" class="form-input" id="serverSeedHashDisplay" readonly value="">
        </div>
        <div class="form-group">
            <label class="form-label">Client Seed</label>
            <input type="text" class="form-input" id="clientSeedInput">
        </div>
        <div class="form-group">
            <label class="form-label">Nonce</label>
            <input type="number" class="form-input" id="nonceInput" readonly value="0">
        </div>
        <button class="modal-btn secondary" onclick="changeClientSeed()">UPDATE SEED</button>
        <button class="modal-btn primary" onclick="closeModal('fairnessModal')">CLOSE</button>
    </div>
</div>

<!-- Stripe Elements Placeholder -->
<div id="payment-element"
    style="padding: 20px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 20px; background: #fff; color: #000;">
    <!-- Stripe UI would inject here -->
    <div style="padding: 15px; text-align: center; color: #555;">(Stripe Secure Payment Element)</div>
</div>
<div class="form-group">
    <label class="form-label">Amount (USD)</label>
    <input type="number" class="form-input" id="depositAmount" value="50">
</div>
<div class="modal-footer">
    <button class="modal-btn secondary" onclick="closeModal('depositModal')">CANCEL</button>
    <button class="modal-btn primary" onclick="processDeposit()">PAY NOW (SECURE)</button>
</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    // Game State (Removed Friends, Added Fairness)
    let gameState = {
        user: null,
        isLoggedIn: false,
        crashCash: 0,
        referralCode: '',
        cardPacks: 0,
        inventory: [],
        collection: new Array(51).fill(0),
        loadout: new Array(10).fill(null),
        unlockedSlots: 1,
        currentGame: null,
        gameHistory: [],
        sessionPL: 0,
        totalProfit: 0,
        dailyRewardClaimed: false,
        // Stats
        winStreak: 0,
        maxWinStreak: 0,
        totalWins: 0,
        totalLosses: 0,
        // Provably Fair
        serverSeed: null,
        serverSeedHash: null,
        clientSeed: 'client_seed_' + Math.floor(Math.random() * 100000),
        nonce: 0
    };

    const gameModes = [
        { name: 'Corca-Cola', ticker: '$CORLA', lambda: 2.5, swingRange: { min: -1.5, max: 1.5 } },
        { name: 'Brokerly', ticker: '$BRKR', lambda: 1.75, swingRange: { min: -3, max: 3 } },
        { name: 'NiftyFox', ticker: '$NFTX', lambda: 1.4, swingRange: { min: -5, max: 5 } },
        { name: 'Etherex', ticker: '$ETHRX', lambda: 1.0, swingRange: { min: -8, max: 8 } },
        { name: 'Tesler', ticker: '$TSLR', lambda: 0.75, swingRange: { min: -12, max: 12 } }
    ];

    // Cards Array (Shortened for brevity but functional)
    const cards = [
        { id: 1, name: 'Steady Gains', rarity: 'common', effect: 'multiplier_boost', value: 0.05, cost: 2, market_advantage: -0.5 },
        { id: 2, name: 'Safety Net', rarity: 'common', effect: 'loss_reduction', value: 0.95, cost: 2, market_advantage: -0.3 },
    ];
    // Populate dummy cards
    for (let i = 3; i <= 51; i++) cards.push({ id: i, name: `Card ${i}`, rarity: 'common', effect: 'none', value: 0, cost: 0, market_advantage: 0 });

    const slotCosts = [0, 100, 250, 500, 1000, 2000, 4000, 8000, 16000, 32000];

    window.onload = function () {
        loadGameState();
        initializeInventory();
        updateUI();
        rotateServerSeed(); // Initialize fairness
    };

    function loadGameState() {
        const saved = localStorage.getItem('crashStreetState');
        if (saved) gameState = JSON.parse(saved);
    }

    function saveGameState() { localStorage.setItem('crashStreetState', JSON.stringify(gameState)); }

    function updateUI() {
        if (gameState.isLoggedIn) {
            document.getElementById('userStats').style.display = 'flex';
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('username').textContent = gameState.user.username;
            document.getElementById('crashCashBalance').textContent = gameState.crashCash.toLocaleString();
        } else {
            document.getElementById('userStats').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'block';
        }
        // Update provably fair inputs
        document.getElementById('clientSeedInput').value = gameState.clientSeed;
        document.getElementById('nonceInput').value = gameState.nonce;
        if (gameState.serverSeedHash) document.getElementById('serverSeedHashDisplay').value = gameState.serverSeedHash;
    }

    function showModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showLoginModal() { showModal('loginModal'); }
    function showEnterCodeModal() { showModal('enterCodeModal'); }
    function showRedeemModal() { showModal('redeemModal'); }
    function showFairnessModal() { showModal('fairnessModal'); }
    function showDepositModal() { showModal('depositModal'); }

    function register() {
        const username = document.getElementById('usernameInput').value;
        if (!username) return;
        gameState.user = { username };
        gameState.isLoggedIn = true;
        gameState.crashCash = 1000;
        saveGameState();
        updateUI();
        closeModal('loginModal');
    }

    function logout() {
        gameState.isLoggedIn = false;
        saveGameState();
        updateUI();
        showPage('mainPage');
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- PROVABLY FAIR SYSTEM ---
    function rotateServerSeed() {
        // In a real app, this comes from server. We simulate it here.
        gameState.serverSeed = generateRandomString(64);
        gameState.serverSeedHash = CryptoJS.SHA256(gameState.serverSeed).toString();
        updateUI();
    }

    function generateRandomString(length) {
        let result = '';
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        for (let i = 0; i < length; i++) result += characters.charAt(Math.floor(Math.random() * characters.length));
        return result;
    }

    function changeClientSeed() {
        gameState.clientSeed = document.getElementById('clientSeedInput').value;
        gameState.nonce = 0; // Reset nonce on seed change
        rotateServerSeed(); // New server seed pair
        showNotification("Seed updated! Next round is provably fair.");
        saveGameState();
    }

    function getCrashPoint() {
        // HMAC(server_seed, client_seed + nonce)
        const combo = gameState.clientSeed + ":" + gameState.nonce;
        const hash = CryptoJS.HmacSHA256(combo, gameState.serverSeed).toString();

        // Take first 8 chars (32 bits) -> int
        const h = parseInt(hash.substring(0, 8), 16);
        const e = Math.pow(2, 32);
        // Result is 0.99 / (1 - (h / e))
        // This is a standard crash game formula
        const crashPoint = Math.floor((100 * 0.99) / (1 - (h / e))) / 100;

        // Ensure minimum 1.00
        return Math.max(1.00, crashPoint);
    }

    // --- STRIPE / PAYMENTS MOCK ---
    function processDeposit() {
        const amount = document.getElementById('depositAmount').value;
        // Mock processing
        showNotification(`Processing secure payment of $${amount}...`);
        setTimeout(() => {
            const cc = amount * 1000; // $1 = 1000 CC
            gameState.crashCash += cc;
            showNotification(`Success! +${cc.toLocaleString()} CC deposited via Stripe.`);
            saveGameState();
            updateUI();
            closeModal('depositModal');
        }, 1500);
    }

    function showNotification(msg) {
        alert(msg); // Placeholder for toast
    }

    // --- INVENTORY ---
    function initializeInventory() {
        const container = document.getElementById('loadoutCards');
        container.innerHTML = '';
        for (let i = 0; i < 10; i++) {
            const slot = document.createElement('div');
            if (i < gameState.unlockedSlots) {
                if (gameState.loadout[i]) {
                    slot.className = 'card-slot equipped';
                    slot.textContent = 'Card ' + gameState.loadout[i];
                    slot.onclick = () => { gameState.loadout[i] = null; saveGameState(); initializeInventory(); };
                } else {
                    slot.className = 'card-slot empty';
                    slot.textContent = 'Empty ' + (i + 1);
                }
            } else {
                slot.className = 'card-slot locked';
                slot.textContent = 'Locked ' + (i + 1);
                slot.onclick = () => {
                    if (gameState.crashCash >= slotCosts[i]) {
                        gameState.crashCash -= slotCosts[i];
                        gameState.unlockedSlots++;
                        saveGameState();
                        initializeInventory();
                    }
                };
            }
            container.appendChild(slot);
        }
        const grid = document.getElementById('collectionGrid');
        grid.innerHTML = '';
        cards.forEach(c => {
            const card = document.createElement('div');
            card.className = 'collection-card ' + c.rarity;
            card.textContent = c.name;
            card.onclick = () => {
                const emptyIdx = gameState.loadout.indexOf(null);
                if (emptyIdx !== -1 && emptyIdx < gameState.unlockedSlots) {
                    gameState.loadout[emptyIdx] = c.id;
                    saveGameState();
                    initializeInventory();
                }
            };
            grid.appendChild(card);
        });
    }


    // --- SOCKET.IO INTEGRATION ---
    const socket = io();

    socket.on('connect', () => {
        console.log("Connected to server");
    });

    socket.on('online_users', (count) => {
        const el = document.getElementById('onlineUsersCount');
        if (el) el.textContent = count;
    });

    socket.on('game_start', (data) => {
        // Data contains nonce, hash, ticker
        gameState.serverSeedHash = data.hash;
        gameState.nonce = data.nonce;
        updateUI();

        // Reset Round UI
        document.getElementById('marketHaltOverlay').classList.remove('active');
        document.getElementById('roundNumber').textContent = `Round ${data.nonce}`;
        document.getElementById('multiplierDisplay').textContent = "1.00x";
        document.getElementById('multiplierDisplay').className = "multiplier-display";

        if (gameState.currentGame) {
            // Check if this start event matches our current mode/ticker
            // The server sends to room, so we can assume validity if we receive it.
            gameState.currentGame.isRunning = true;
            gameState.currentGame.currentMultiplier = 1.00;
        }
    });

    socket.on('tick', (multiplier) => {
        if (gameState.currentGame) {
            gameState.currentGame.currentMultiplier = multiplier;
            document.getElementById('multiplierDisplay').textContent = multiplier.toFixed(2) + 'x';
        }
    });

    socket.on('crash', (data) => {
        document.getElementById('multiplierDisplay').textContent = data.multiplier.toFixed(2) + 'x';
        document.getElementById('multiplierDisplay').className = "multiplier-display negative";
        document.getElementById('marketHaltOverlay').classList.add('active');

        // Handle loss
        if (gameState.currentGame && gameState.currentGame.hasBet) {
            endGame(false);
        }
    });

    socket.on('cash_out_success', (data) => {
        const effects = applyCardEffects();
        let mult = gameState.currentGame.currentMultiplier;
        if (effects.multiplierBoost > 1) mult *= effects.multiplierBoost;

        const win = gameState.currentGame.betAmount * mult;
        gameState.crashCash += win;
        gameState.totalProfit += (win - gameState.currentGame.betAmount);
        gameState.winStreak++;
        gameState.totalWins++;

        endGame(true);
        showNotification(`Cashed out at ${mult.toFixed(2)}x! Won ${win.toFixed(0)} CC`);
    });

    socket.on('pack_bought', (data) => {
        if (data.success) {
            gameState.cardPacks++;
            saveGameState();
            updateUI();
            alert("Pack purchased! Go to Inventory to open.");
        }
    });

    socket.on('code_redeemed', (data) => {
        if (data.success) {
            gameState.crashCash += data.amount;
            saveGameState();
            updateUI();
            closeModal('enterCodeModal');
            showNotification(`Code Redeemed! +${data.amount} CC`);
        } else {
            alert("Invalid Code");
        }
    });


    // --- CLIENT INTERACTION ---

    function startGame(modeIdx) {
        if (!gameState.isLoggedIn) return showLoginModal();

        const mode = gameModes[modeIdx];
        // Room Key: remove $ from ticker
        const roomKey = mode.ticker.replace('$', '');

        gameState.currentGame = {
            mode: mode,
            round: 0,
            currentMultiplier: 1.0,
            isRunning: false,
            hasBet: false
        };

        socket.emit('join_room', roomKey);
        showPage('gamePage');
    }

    function placeBet() {
        const amt = parseInt(document.getElementById('betAmount').value);
        if (gameState.crashCash >= amt) {
            gameState.crashCash -= amt;
            gameState.currentGame.betAmount = amt;
            gameState.currentGame.hasBet = true;
            socket.emit('place_bet', { amount: amt });
            updateUI();
        }
    }

    function cashOut() {
        if (gameState.currentGame && gameState.currentGame.hasBet) {
            socket.emit('cash_out');
        }
    }

    function endGame(won) {
        gameState.currentGame.hasBet = false;
        if (!won) {
            const effects = applyCardEffects();
            if (effects.lossReduction < 1) {
                const refund = gameState.currentGame.betAmount * (1 - effects.lossReduction);
                if (refund > 0) {
                    gameState.crashCash += refund;
                    showNotification(`Insurance saved ${refund.toFixed(0)} CC!`);
                }
            }
            gameState.winStreak = 0;
            gameState.totalLosses++;
        }
        updateUI();
        saveGameState();
    }

    // --- NEW PHASE 3 FEATURES ---
    function submitReferralCode() {
        const code = document.getElementById('referralInput').value;
        socket.emit('redeem_code', code);
    }

    function buyCardPack() {
        if (gameState.crashCash >= 500) {
            gameState.crashCash -= 500;
            saveGameState();
            updateUI();
            socket.emit('buy_pack');
        } else {
            alert("Not enough CC (500 needed)");
        }
    }

    function openPack() {
        if (gameState.cardPacks > 0) {
            gameState.cardPacks--;
            // Local sim for prototype visual (Server logic would be robust generation)
            // Just unlock random cards or add duplicates?
            // Simple: Unlock 3 random types
            let gained = [];
            for (let i = 0; i < 3; i++) {
                const randomId = Math.floor(Math.random() * 50) + 1;
                // Add to collection logic (simplified count increment)
                gameState.collection[randomId] = (gameState.collection[randomId] || 0) + 1;
                gained.push(randomId);
            }
            saveGameState();
            updateUI();

            // Visual Reveal (Quick Alert for now or overlay if CSS exists)
            alert(`Pack Opened! You got Cards: ${gained.join(', ')}`);
        } else {
            alert("No packs to open!");
        }
    }


    // RECONSTRUCTED LOGIC
    function applyCardEffects() {
        if (!gameState.loadout) return {};

        const effects = {
            multiplierBoost: 1,
            lossReduction: 1,
            totalMarketAdvantage: 0
        };

        // Loop through equipped cards
        if (gameState.loadout) {
            gameState.loadout.forEach(cardId => {
                if (!cardId) return;
                const card = cards.find(c => c.id === cardId);
                if (!card) return;

                // Add market advantage
                if (card.market_advantage) effects.totalMarketAdvantage += card.market_advantage;

                // Apply specific effects by type
                if (card.effect === 'multiplier_boost') {
                    effects.multiplierBoost += card.value;
                } else if (card.effect === 'loss_reduction') {
                    // Assuming simplest application: keep the best reduction or multiply? 
                    // Prompt implied 5% reduction, so 0.95 multiplier
                    effects.lossReduction *= card.value;
                }
            });
        }

        return effects;
    }
</script>
</body>

</html>